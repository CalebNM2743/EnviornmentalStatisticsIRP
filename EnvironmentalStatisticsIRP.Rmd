---
title: "EnvironmentalStatisticsIRP"
output: pdf_document
---

### Getting Started

Always have to start with loading in a few libraries I'm sure I'll need

```{r}
library(tidyverse)
library(ggplot2)
```


### Getting the Data

Need to read in 2 critical things: my actual data, as well as my shapefiles for PNF. This data is in a very raw state, so it will take quite a bit of modification to get it into my actual database.

First, I'll read in my raw data, clean it, and make it into a single database. This is a lot of data and will require a lot of cleaning to get into a single database.

```{r}
# Reading in the CSVs. There were multiple files, due to the size of the database being difficult to download the whole forest, so I would have to download by district, and then multiple protocols that had individual tabs in the XLS doc (should all be DWR for the actual composition method). Mismatching names with Chino Valley 2 coming from 3 is intentional, I got data that is too difficult to work with in there so I'm omitting it for now.

RawBradshaw1 <- read_csv("RawData/RawPNFBradshawData.csv")
RawBradshaw2 <- read_csv("RawData/RawPNFBradshawData2.csv")
RawChinoValley1 <- read_csv("RawData/RawPNFChinoValleyData.csv")
RawChinoValley2 <- read_csv("RawData/RawPNFChinoValleyData3.csv")
RawVerde1 <- read_csv("RawData/RawPNFVerdeData.csv")
RawVerde2 <- read_csv("RawData/RawPNFVerdeData2.csv")

#From here, I'm going to treat to A) have only the columns I need (site name, location, species, and ranking) and B) rename some columns to something more applicable.

CleanPNF <- function(df) {
  CleanData <- df %>% 
    select(Date, Ancestry, SiteID, SpeciesSymbol, SpeciesName, CommonName, SampleNumber, nValue, DDLat, DDLong) %>% 
    rename(Rank = nValue,
           Lat = DDLat,
           Lon = DDLong)
  return(CleanData)
}
  
Bradshaw1Refined <- CleanPNF(RawBradshaw1)
Bradshaw2Refined <- CleanPNF(RawBradshaw2)
ChinoValley1Refined <- CleanPNF(RawChinoValley1)
ChinoValley2Refined <- CleanPNF(RawChinoValley2)
Verde1Refined <- CleanPNF(RawVerde1)
Verde2Refined <- CleanPNF(RawVerde2)


#Combine the main group into one dataframe

PNFFirst <- Bradshaw1Refined %>% 
  full_join(Bradshaw2Refined) %>% 
  full_join(ChinoValley1Refined) %>% 
  full_join(ChinoValley2Refined) %>% 
  full_join(Verde1Refined) %>% 
  full_join(Verde2Refined)

```

That's my first dataframe, so now I'm going to narrow this data down to the point where I can get the composition for each species on each site. To do this, I will count each rank each species got per site (How many times was BOCU ranked 1 on X site in Y event?). This will involve creating a new dataframe, as the per sample data will become irrelevant.

```{r}
PNFSecond <- PNFFirst %>% 
  group_by(Ancestry, SiteID, Lat, Lon, Date, SpeciesSymbol, Rank) %>% 
  summarize(RankCount = n())

PNFSecond <- PNFSecond %>% 
  mutate(Rank = case_when(
    Rank == 1 ~ 7,
    Rank == 2 ~ 2,
    Rank == 3 ~ 1,
    TRUE ~ Rank
  ))

PNFSecond

PNFPreComposition <- PNFSecond %>% 
  group_by(Ancestry, SiteID, Lon, Lat, Date, SpeciesSymbol) %>% 
  summarize(PreComp = Rank*RankCount)

PNFComposition <- PNFPreComposition %>% 
  group_by(Ancestry, SiteID, Lon, Lat, Date, SpeciesSymbol) %>% 
  summarize("Composition(%)" = sum(PreComp)/10)

```

Here I'm going to split columns into allotment and pasture as well as only including the most recent reading at each site and in each pasture (I want to project composition across a whole pasture, if there are multiple compositions per pasture, that will complicate things)

```{r}
#Create the new columns with the string split functions
PNFComposition <- PNFComposition %>% 
  mutate(Allotment = str_split_fixed(Ancestry, " > ", 6) [, 5]) %>% 
  mutate(Pasture = str_split_fixed(Ancestry, " > ", 6) [, 6])

#Filter out unnecessary sites and events, I want only the most recent reading per pasture, as well as those that actually have coordinates.
PNFComposition <- PNFComposition %>% 
  filter(!is.na(Lon))

PNFComposition <- PNFComposition %>% 
  group_by(SiteID) %>% 
  filter(Date == max(Date)) %>% 
  ungroup()

PNFComposition <- PNFComposition %>% 
  group_by(Pasture) %>% 
  filter(Date == max(Date)) %>% 
  ungroup()

PNFComposition
```

### Very Important: Choose Your Species

This will be one final modification to the dataframe, where we select what species we want to visualize across the map. I am going to sample blue grama, whose code is BOGR2.

```{r}
SelectedSpComp <- PNFComposition %>% 
  group_by(Pasture) %>% 
  filter(SpeciesSymbol == "BOGR2") %>% 
  ungroup()

SelectedSpComp
```

Now I need to enter my shapefiles, which will give me the allotment and pasture boundaries for Prescott National Forest.

```{r}
library(sf)
library(ggmap)

AllotmentBoundaries <- st_read("Shapefiles/PNFAllotmentBoundaries.shp")
AllotmentBoundaries_sf <- st_as_sf(AllotmentBoundaries, coords = c("lon", "lat"))
AllotmentBoundaries_sf <- st_transform(AllotmentBoundaries_sf, crs = 4326)

PastureBoundaries <- st_read("Shapefiles/PNFPastureBoundaries.shp")
PastureBoundaries_sf <- st_as_sf(PastureBoundaries, coords = c("lon", "lat"))
PastureBoundaries_sf <- st_transform(PastureBoundaries_sf, crs = 4326)

plot(AllotmentBoundaries_sf$geometry)
plot(PastureBoundaries_sf$geometry)
```

Now I'm going to try and plot the locations of my sites by turning PNFComposition into a sf

```{r}
SelectedSpComp_sf <- st_as_sf(SelectedSpComp, coords = c("Lon", "Lat"))

plot(PastureBoundaries_sf$geometry)
plot(SelectedSpComp_sf$geometry, col = "blue", add = T)
```

Ok now I am going to attempt to make a heat map generating blue grama composition on the maps. First I'm going to make a grid of intersects that will tell the situation what to shade what pastures.

```{r}
st_crs(SelectedSpComp_sf) <- "+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"
st_crs(PastureBoundaries_sf) <- "+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"

PastureComposition <- st_intersects(PastureBoundaries_sf, SelectedSpComp_sf)

PastureComposition

```

Finally I am going to make my map, I am partial to the viridis color scheme so that is what will be used.

```{r}
library(viridis)
PastureBoundaries_sf <- left_join()

```

A composition map that should be able to be modified and show different compositions depending on the SelectedSpComp function, where we select the species we would like to have and put into the function