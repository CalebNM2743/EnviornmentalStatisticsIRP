---
title: "EnvironmentalStatisticsIRP"
output: pdf_document
---

### Getting Started

Always have to start with loading in a few libraries I'm sure I'll need

```{r}
library(tidyverse)
library(ggplot2)
```

### Getting the Data

Need to read in 2 critical things: my actual data, as well as my shapefiles for PNF. This data is in a very raw state, so it will take quite a bit of modification to get it into my actual database.

First, I'll read in my raw data, clean it, and make it into a single database. This is a lot of data and will require a lot of cleaning to get into a single database.

```{r}
# Reading in the CSVs. There were multiple files, due to the size of the database being difficult to download the whole forest, so I would have to download by district, and then multiple protocols that had individual tabs in the XLS doc (should all be DWR for the actual composition method). Mismatching names with Chino Valley 2 coming from 3 is intentional, I got data that is too difficult to work with in there so I'm omitting it for now.

RawBradshaw1 <- read_csv("RawData/RawPNFBradshawData.csv")
RawBradshaw2 <- read_csv("RawData/RawPNFBradshawData2.csv")
RawChinoValley1 <- read_csv("RawData/RawPNFChinoValleyData.csv")
RawChinoValley2 <- read_csv("RawData/RawPNFChinoValleyData3.csv")
RawVerde1 <- read_csv("RawData/RawPNFVerdeData.csv")
RawVerde2 <- read_csv("RawData/RawPNFVerdeData2.csv")

#From here, I'm going to treat to A) have only the columns I need (site name, location, species, and ranking) and B) rename some columns to something more applicable.

CleanPNF <- function(df) {
  CleanData <- df %>% 
    select(Date, Ancestry, SiteID, SpeciesSymbol, SpeciesName, CommonName, SampleNumber, nValue, DDLat, DDLong) %>% 
    rename(Rank = nValue,
           Lat = DDLat,
           Lon = DDLong)
  return(CleanData)
}
  
Bradshaw1Refined <- CleanPNF(RawBradshaw1)
Bradshaw2Refined <- CleanPNF(RawBradshaw2)
ChinoValley1Refined <- CleanPNF(RawChinoValley1)
ChinoValley2Refined <- CleanPNF(RawChinoValley2)
Verde1Refined <- CleanPNF(RawVerde1)
Verde2Refined <- CleanPNF(RawVerde2)


#Combine the main group into one dataframe

PNFFirst <- Bradshaw1Refined %>% 
  full_join(Bradshaw2Refined) %>% 
  full_join(ChinoValley1Refined) %>% 
  full_join(ChinoValley2Refined) %>% 
  full_join(Verde1Refined) %>% 
  full_join(Verde2Refined)

```

### Getting Composition

That's my first dataframe, so now I'm going to narrow this data down to the point where I can get the composition for each species on each site. To do this, I will count each rank each species got per site (How many times was BOCU ranked 1 on X site in Y event?). This will involve creating a new dataframe, as the per sample data will become irrelevant.

```{r}
#Create a count of how many times each Rank was assigned per species

PNFSecond <- PNFFirst %>% 
  group_by(Ancestry, SiteID, Lat, Lon, Date, SpeciesSymbol, Rank) %>% 
  summarize(RankCount = n())

#Assign true values to the Ranks

PNFSecond <- PNFSecond %>% 
  mutate(Rank = case_when(
    Rank == 1 ~ 7,
    Rank == 2 ~ 2,
    Rank == 3 ~ 1,
    TRUE ~ Rank
  ))

#Change Date to an actual date data

PNFSecond$Date <- as.POSIXct(PNFSecond$Date, format = "%m/%d/%Y")

#Only select most recent event per site

PNFSecond <- PNFSecond %>% 
  group_by(Ancestry, SiteID) %>% 
  slice_max(Date, n = 1) %>% 
  ungroup()

PNFSecond

#Determine how many frames were read per event (Composition is determined by taking the total value of Rank*RankCount divided by how many frames were read per site. Some sites were read with 100 frames, some were read with 200 which can understandably inflate composition if dividing by 100 instead of 200).

PNFThird <- PNFSecond %>% 
  group_by(Ancestry, SiteID) %>% 
  summarize(SiteTotalFrames = sum(RankCount)/3) %>% 
  ungroup()

PNFThird

#Get the Rank*RankCount value

PNFPreComposition <- PNFSecond %>% 
  group_by(Ancestry, SiteID, Lon, Lat, Date, SpeciesSymbol) %>% 
  summarize(PreComp = Rank*RankCount)

#Connect PNFThird to PNFPreComposition so that PNFPreComposition has the SiteTotalFrames

PNFPreComposition <- full_join(PNFPreComposition, PNFThird, join_by(Ancestry, SiteID))

PNFPreComposition

#Get actual Composition

PNFComposition <- PNFPreComposition %>% 
  group_by(Ancestry, SiteID, Lon, Lat, Date, SpeciesSymbol, SiteTotalFrames) %>% 
  summarize(Composition = sum(PreComp))

PNFComposition$Composition <- 10*PNFComposition$Composition/PNFComposition$SiteTotalFrames

PNFComposition
```

Here I'm going to split columns into allotment and pasture as well as only including the most recent reading at each site and in each pasture (I want to project composition across a whole pasture, if there are multiple compositions per pasture, that will complicate things)

```{r}
#Create the new columns with the string split functions

PNFComposition <- PNFComposition %>% 
  mutate(Allotment = str_split_fixed(Ancestry, " > ", 6) [, 5]) %>% 
  mutate(Pasture = str_split_fixed(Ancestry, " > ", 6) [, 6])

#Filter out unnecessary sites and events, I want only the most recent reading per pasture, as well as those that actually have coordinates.

PNFComposition <- PNFComposition %>% 
  filter(!is.na(Lon))

#Select only the most recent event per pasture

PNFComposition <- PNFComposition %>% 
  group_by(Pasture) %>% 
  filter(Date == max(Date)) %>% 
  ungroup()

PNFComposition
```

### Very Important: Choose Your Species

This will be one final modification to the dataframe, where we select what species we want to visualize across the map. I am going to sample blue grama, whose code is BOGR2.

```{r}
#Create dataframe that only has the target species involved

SelectedSpComp <- PNFComposition %>% 
  group_by(Pasture) %>% 
  filter(SpeciesSymbol == "BOCU") %>% #Can swap out the species code with any desired species code for a new composition framework
  ungroup()

SelectedSpComp
```

### Making the Map

Now I need to enter my shapefiles, which will give me the pasture boundaries for Prescott National Forest.

```{r}
library(sf)
library(ggmap)

PastureBoundaries <- st_read("Shapefiles/PNFPastureBoundaries.shp")
```

Finally, I will do some final tweaking to my code and eventually, spit out the map that is needed.

```{r}
#First remove the spaces (not sure this is needed, but spaces in column names can sometimes create headaches)

SelectedSpComp$Allotment <- gsub(" ", "", SelectedSpComp$Allotment)

#Remove the word allotment to match the PastureBoundaries naming convention

SelectedSpComp$Allotment <- gsub("Allotment", "", SelectedSpComp$Allotment)

#Do the same process for the pasture column

SelectedSpComp$Pasture <- gsub(" ", "", SelectedSpComp$Pasture)
SelectedSpComp$Pasture <- gsub("Pasture", "", SelectedSpComp$Pasture)

#Combine into single column called AP (allotment_pasture)

SelectedSpComp$AP <- paste0(SelectedSpComp$Allotment, "_", SelectedSpComp$Pasture)

#Do the same process for PastureBoundaries

PastureBoundaries$UNIT_NAME <- gsub(" ", "", PastureBoundaries$UNIT_NAME)
PastureBoundaries$SUB_NAME <- gsub(" ", "", PastureBoundaries$SUB_NAME)
PastureBoundaries$AP <- paste0(PastureBoundaries$UNIT_NAME, "_", PastureBoundaries$SUB_NAME)

#Merge but keep all rows from PastureBoundaries (all.x = T). This created 2 extra rows, so there is likely a naming mismatch somewhere....

MergedDatas <- merge(PastureBoundaries, SelectedSpComp, all.x = T)

#Make spatial

MergedDatas_sf <- st_as_sf(MergedDatas, coords = c("lon", "lat"))
MergedDatas_sf <- st_transform(MergedDatas_sf, crs = 4326)

#Plot based on composition

library(viridis)
plot(MergedDatas_sf["Composition"],
     pal = viridis)

```

A composition map that should be able to be modified and show different compositions depending on the SelectedSpComp function, where we select the species we would like to have and put into the function